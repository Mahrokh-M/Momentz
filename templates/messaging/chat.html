{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with {{ receiver_username }} - Momentz{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Chat with {{ receiver_username }}</h1>
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div id="chat-container" class="p-4 max-h-96 overflow-y-auto" style="scroll-behavior: smooth;">
            {% for msg in messages %}
                <div class="message mb-4 {% if msg.sender.user_id == request.user.user_id %}sent{% else %}received{% endif %}" 
                     data-message-id="{{ msg.message_id }}">
                    <div class="flex {% if msg.sender.user_id == request.user.user_id %}justify-end{% else %}justify-start{% endif %} items-center space-x-2">
                        {% if msg.sender.user_id != request.user.user_id %}
                            <img src="{% if receiver_picture_url and receiver_picture_url|length > 0 %}{{ receiver_picture_url }}{% else %}{% static 'images/default_avatar.jpg' %}{% endif %}" 
                                 alt="Receiver Avatar" class="w-8 h-8 rounded-full">
                        {% endif %}
                        <div class="max-w-xs p-3 rounded-lg {% if msg.sender.user_id == request.user.user_id %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-800{% endif %}">
                            <p class="text-sm">{{ msg.content }}</p>
                            <p class="text-xs mt-1 opacity-75">{{ msg.sent_at|date:"M d, Y H:i" }}</p>
                        </div>
                        {% if msg.sender.user_id == request.user.user_id %}
                            <img src="{% if user_picture_url and user_picture_url|length > 0 %}{{ user_picture_url }}{% else %}{% static 'images/default_avatar.jpg' %}{% endif %}" 
                                 alt="Your Avatar" class="w-8 h-8 rounded-full">
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p class="text-gray-600 text-center py-4">No messages yet. Start a conversation!</p>
            {% endfor %}
        </div>
        <div class="p-4 border-t">
            <form id="message-form" class="flex space-x-2">
                <input type="hidden" name="receiver_id" value="{{ receiver_id }}">
                <textarea id="message-content" name="content" class="w-full p-2 border rounded-lg resize-none" rows="2" 
                          placeholder="Type a message..." required></textarea>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Send</button>
            </form>
        </div>
    </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatContainer = document.getElementById('chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
</script>
<script src="{% static 'js/messaging.js' %}"></script>

<style>
.message.sent { 
    animation: slideRight 0.3s ease-out; 
}
.message.received { 
    animation: slideLeft 0.3s ease-out; 
}
@keyframes slideRight {
    from { transform: translateX(20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideLeft {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
#chat-container::-webkit-scrollbar {
    width: 8px;
}
#chat-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}
#chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}
</style>
{% endblock %}